<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>3D 真實地球 8K + 夜光</title>
<style>
body { margin: 0; overflow: hidden; background: #000; }
#toggleNight {
    position: absolute; top: 10px; left: 10px;
    padding: 8px 12px; background: rgba(0,0,0,0.6);
    color: #4db8ff; border: 1px solid #4db8ff;
    border-radius: 4px; cursor: pointer;
    font-family: sans-serif;
    z-index: 10;
}
</style>
<script type="importmap">
{
  "imports": {
    "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
    "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
  }
}
</script>
</head>
<body>
<div id="toggleNight">切換城市夜光</div>
<script type="module">
import * as THREE from 'three';
import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
import { RGBELoader } from 'three/addons/loaders/RGBELoader.js';

let scene, camera, renderer, controls;
let earthMesh, cloudMesh, nightMesh;
let cityLightVisible = true;
const clock = new THREE.Clock();

// --- 初始化 ---
init();
animate();

function init() {
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x000000);

    camera = new THREE.PerspectiveCamera(45, window.innerWidth/window.innerHeight, 0.1, 1000);
    camera.position.set(0, 0, 15);

    renderer = new THREE.WebGLRenderer({ antialias:true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio,2));
    renderer.toneMapping = THREE.ACESFilmicToneMapping;
    renderer.toneMappingExposure = 1.0;
    renderer.outputColorSpace = THREE.SRGBColorSpace;
    document.body.appendChild(renderer.domElement);

    // --- 控制器 ---
    controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.05;
    controls.minDistance = 5;
    controls.maxDistance = 30;

    // --- 燈光 ---
    const hemiLight = new THREE.HemisphereLight(0xffffff, 0xffffff, 1.6);
    scene.add(hemiLight);

    // --- HDR 環境貼圖 ---
    new RGBELoader().load(
        'https://threejs.org/examples/textures/equirectangular/royal_esplanade_1k.hdr',
        function(texture){
            texture.mapping = THREE.EquirectangularReflectionMapping;
            scene.environment = texture;
        }
    );

    // --- 地球貼圖 8K ---
    const loader = new THREE.TextureLoader();
    const earthMap = loader.load('https://raw.githubusercontent.com/mrdoob/three.js/master/examples/textures/planets/earth_atmos_8192.jpg');
    const earthNormal = loader.load('https://raw.githubusercontent.com/mrdoob/three.js/master/examples/textures/planets/earth_normal_8192.jpg');
    const earthSpec = loader.load('https://raw.githubusercontent.com/mrdoob/three.js/master/examples/textures/planets/earth_specular_8192.jpg');
    const cityLights = loader.load('https://raw.githubusercontent.com/mrdoob/three.js/master/examples/textures/planets/earth_lights_8192.png');

    // --- 地球材質 ---
    const earthMaterial = new THREE.MeshStandardMaterial({
        map: earthMap,
        normalMap: earthNormal,
        metalness: 0.05,
        roughness: 0.6,
    });

    earthMesh = new THREE.Mesh(
        new THREE.SphereGeometry(5, 128, 128),
        earthMaterial
    );
    earthMesh.rotation.y = -Math.PI/2;
    scene.add(earthMesh);

    // --- 雲層 ---
    const cloudMaterial = new THREE.MeshStandardMaterial({
        map: loader.load('https://raw.githubusercontent.com/mrdoob/three.js/master/examples/textures/planets/earth_clouds_8192.png'),
        transparent: true,
        opacity: 0.5,
        depthWrite: false
    });
    cloudMesh = new THREE.Mesh(
        new THREE.SphereGeometry(5.05, 128, 128),
        cloudMaterial
    );
    cloudMesh.rotation.y = -Math.PI/2;
    scene.add(cloudMesh);

    // --- 夜光層 ---
    const nightMaterial = new THREE.MeshBasicMaterial({
        map: cityLights,
        transparent: true,
        opacity: 1.0
    });
    nightMesh = new THREE.Mesh(
        new THREE.SphereGeometry(5.001, 128, 128),
        nightMaterial
    );
    nightMesh.rotation.y = -Math.PI/2;
    scene.add(nightMesh);

    // --- 夜光開關 ---
    document.getElementById('toggleNight').addEventListener('click', ()=>{
        cityLightVisible = !cityLightVisible;
        nightMesh.visible = cityLightVisible;
    });

    window.addEventListener('resize', ()=>{
        camera.aspect = window.innerWidth/window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    });
}

// --- 動畫 ---
function animate() {
    requestAnimationFrame(animate);
    const t = clock.getElapsedTime();

    // 地球自轉
    earthMesh.rotation.y += 0.0005;
    cloudMesh.rotation.y += 0.0008;
    nightMesh.rotation.y += 0.0005;

    controls.update();
    renderer.render(scene, camera);
}
</script>
</body>
</html>
